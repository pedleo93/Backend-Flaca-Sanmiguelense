<app-nav></app-nav>

<div class="grid text-center m-1">
  <div class="col-4">
    <p-card styleClass="stat-card">
      <i class="pi pi-calendar text-blue-500 text-3xl mb-2"></i>
      <div class="text-2xl font-bold">
        {{ calls.length || 0 }}
      </div>
      <div class="text-sm text-500">Convocatorias Totales</div>
    </p-card>
  </div>

  <div class="col-4">
    <p-card styleClass="stat-card">
      <i class="pi pi-users text-green-500 text-3xl mb-2"></i>
      <div class="text-2xl font-bold">
        {{ stats?.total_registros || 0 }}
      </div>
      <div class="text-sm text-500">Registros Totales</div>
    </p-card>
  </div>

  <div class="col-4">
    <p-card styleClass="stat-card">
      <i class="pi pi-dollar text-yellow-500 text-3xl mb-2"></i>
      <div class="text-2xl font-bold">
        {{ (stats?.monto_total || 0) | currency : "MXN" : "symbol" : "1.2-2" }}
      </div>
      <div class="text-sm text-500">Ingresos Totales</div>
    </p-card>
  </div>
</div>

<p-toast position="top-center"></p-toast>

<p-card header="Verificar Pago de Registro">
  <div class="p-fluid flex mb-4">
    <input pInputText id="codigoBusqueda" [(ngModel)]="codigoBusqueda"
      placeholder="Ingresa el código de inscripción (Ej: T5URZ)" (keyup.enter)="buscarRegistro()"
      class="border-noround-right" />
    <button pButton icon="pi pi-search" label="Buscar" (click)="buscarRegistro()" [loading]="buscando"
      class="border-noround-left">
    </button>
  </div>

  <div *ngIf="buscando" class="text-center p-3">
    <i class="pi pi-spin pi-spinner" style="font-size: 2.5rem"></i>
  </div>

  <div *ngIf="mensajeError"
    class="p-3 border-round bg-yellow-100 border-1 border-yellow-400 text-yellow-800 flex align-items-center">
    <i class="pi pi-exclamation-triangle mr-2"></i>
    <span>{{ mensajeError }}</span>
  </div>

  <div *ngIf="registroEncontrado">
    <p-fieldset legend="Detalles del Registro" [toggleable]="true">
      <div class="p-fluid grid">
        <div class="field col-12">
          <span class="font-bold">Nombre del equipo:</span>
          <p class="mt-1">{{ registroEncontrado.nombre_equipo }}</p>
        </div>
        <div class="field col-12">
          <span class="font-bold">Participantes:</span>
          <p class="mt-1" style="white-space: pre-line;">{{ registroEncontrado.participantes }}</p>
        </div>
        <div class="field col-12 md:col-6">
          <span class="font-bold">Correo:</span>
          <p class="mt-1">{{ registroEncontrado.correo }}</p>
        </div>
        <div class="field col-12 md:col-6">
          <span class="font-bold">Código:</span>
          <p class="mt-1">{{ registroEncontrado.codigo }}</p>
        </div>
      </div>

      <p-divider></p-divider>

      <div class="flex justify-content-between align-items-center mt-3">
        <span class="font-bold text-xl">Estado del Pago:</span>
        <p-tag [severity]="getStatusSeverity(registroEncontrado.pagado)" [value]="statusPago(registroEncontrado.pagado)"
          (click)="onChangeStatus(registroEncontrado, $event)" styleClass="cursor-pointer text-lg p-2"
          pTooltip="Clic para cambiar estado" tooltipPosition="top">
        </p-tag>
      </div>
    </p-fieldset>
  </div>
</p-card>

<div class="card">
  <div class="grid">
    <div *ngFor="let convocatoria of calls" class="col-12 md:col-6 xl:col-4 p-3">
      <p-card styleClass="h-100 flex flex-column card-compact">
        <ng-template pTemplate="header">
          <div class="relative">
            <img [alt]="convocatoria.nombre" [src]="convocatoria.imagen" class="w-full h-15rem object-cover" />
            <p-tag styleClass="absolute top-0 right-0 m-2 shadow-2"
              [severity]="convocatoria.activo ? 'success' : 'danger'"
              [value]="convocatoria.activo ? 'Activa' : 'Cerrada'">
            </p-tag>
          </div>
        </ng-template>

        <h3 class="font-bold m-0">{{ convocatoria.nombre }}</h3>
        <ng-template pTemplate="footer">
          <div class="border-top-1 surface-border pt-2 mt-auto">
            <div class="flex align-items-center justify-content-between text-sm">
              <span class="p-chip">
                <i class="pi pi-users mr-2"></i>
                <span>{{ convocatoria.registros_count }} Registrados</span>
              </span>
              <span class="font-bold text-lg">
                {{ convocatoria.costo | currency:'MXN':'symbol':'1.0-0' }}
              </span>
            </div>

            <div class="flex justify-content-end gap-2">
              <button (click)="viewRegisters(convocatoria.id)" pButton pRipple icon="pi pi-eye"
                class="p-button-rounded p-button-info" pTooltip="Ver Registros" tooltipPosition="top"></button>
              <button (click)="editCall(convocatoria)" pButton pRipple icon="pi pi-pencil"
                class="p-button-rounded p-button-success" pTooltip="Editar" tooltipPosition="top"></button>
              <button *ngIf="false" (click)="deleteCall(convocatoria.id)" pButton pRipple icon="pi pi-trash"
                class="p-button-rounded p-button-danger" pTooltip="Eliminar" tooltipPosition="top"></button>
            </div>
          </div>
        </ng-template>
      </p-card>
    </div>

    <div *ngIf="!calls || calls.length === 0" class="col-12 text-center py-6">
      <i class="pi pi-inbox" style="font-size: 3rem"></i>
      <h3>No hay convocatorias disponibles.</h3>
      <p>Vuelve a intentarlo más tarde.</p>
    </div>
  </div>
</div>


<p-dialog [(visible)]="dialogVisible" [modal]="true" [responsive]="true" [style]="{ width: '800px', height: '900px' }"
  [header]="dialogHeader">
  <form [formGroup]="callForm" (ngSubmit)="saveCall()">
    <div class="p-fluid">
      <div class="p-field">
        <label for="nombre">Nombre</label>
        <input id="nombre" type="text" pInputText formControlName="nombre" />
        <small style="font-size: 10px; color: red" *ngIf="
            callForm.get('nombre')?.invalid && callForm.get('nombre')?.touched
          " class="text-danger">Nombre es requerido.</small>
      </div>

      <div class="p-field">
        <label for="reglas">Reglas</label>
        <p-editor id="reglas" pInputTextarea formControlName="reglas"></p-editor>
        <small style="font-size: 10px; color: red" *ngIf="
            callForm.get('reglas')?.invalid && callForm.get('reglas')?.touched
          " class="text-danger">Reglas son requeridas.</small>
      </div>

      <div class="p-field">
        <label for="fechaCierre">Fecha y Hora de Cierre:</label>
        <p-calendar formControlName="fecha_cierre" [showTime]="true" hourFormat="12" [inline]="true"
          placeholder="Selecciona la fecha y hora"></p-calendar>
        <small style="font-size: 10px; color: red" *ngIf="fieldInvalid('fecha_cierre')" class="text-danger">Fecha y Hora
          son requeridas.</small>
      </div>

      <div class="p-field">
        <label for="costo">Costo</label>
        <input id="costo" type="number" pInputText formControlName="costo" />
        <small style="font-size: 10px; color: red" *ngIf="
            callForm.get('costo')?.invalid && callForm.get('costo')?.touched
          " class="text-danger">Costo es requerido y debe ser mayor o igual a 0.</small>
      </div>
      <div class="p-field">
        <label for="imagen">Imagen</label>
        <input id="imagen" type="text" pInputText formControlName="imagen" />
        <small style="font-size: 10px; color: red" *ngIf="
            callForm.get('imagen')?.invalid && callForm.get('imagen')?.touched
          " class="text-danger">La imagen es requerida.</small>
      </div>
    </div>
    <div class="dialog-footer">
      <p-button icon="pi pi-times" (click)="dialogVisible = false" label="Cancelar"
        styleClass="p-button-text"></p-button>
      <p-button icon="pi pi-check" [disabled]="callForm.invalid" type="submit" label="Aceptar"
        styleClass="p-button-text"></p-button>
    </div>
    <!-- <ng-template pTemplate="footer">
            <p-button icon="pi pi-times" (click)="dialogVisible = false" label="Cancelar" styleClass="p-button-text"></p-button>
            <p-button icon="pi pi-check" [disabled]="callForm.invalid" type="submit" label="Aceptar" styleClass="p-button-text"></p-button>
        </ng-template> -->
  </form>
</p-dialog>

<p-dialog header="Confirmar Eliminación" [(visible)]="visibleDelete" [style]="{ width: '25vw' }"
  class="flex flex-column flex-wrap">
  <ng-template pTemplate="header">
    <span class="text-xl font-bold">Eliminar convocatoria</span>
  </ng-template>

  <p>Estas a punto de eliminar una convocatoria. ¿Quieres continuar?</p>

  <ng-template pTemplate="footer">
    <p-button icon="pi pi-times" (click)="visibleDelete = false" label="Cancelar" styleClass="p-button-text"></p-button>
    <p-button icon="pi pi-check" [disabled]="disableDelete" (click)="confirmDelete()" label="Aceptar"
      styleClass="p-button-text"></p-button>
  </ng-template>
</p-dialog>

<p-dialog header="Confirmar Eliminación" [(visible)]="visibleDelMany" [style]="{ width: '25vw' }"
  class="flex flex-column flex-wrap">
  <ng-template pTemplate="header">
    <span class="text-xl font-bold">Eliminar convocatorias</span>
  </ng-template>

  <p>Estás a punto de eliminar varias convocatorias. ¿Quieres continuar?</p>

  <ng-template pTemplate="footer">
    <p-button icon="pi pi-times" (click)="visibleDelMany = false" label="Cancelar"
      styleClass="p-button-text"></p-button>
    <p-button icon="pi pi-check" [disabled]="disableDeleteMany" (click)="deleteSelected()" label="Aceptar"
      styleClass="p-button-text"></p-button>
  </ng-template>
</p-dialog>

<p-dialog [(visible)]="visibleRegister" [responsive]="true" [modal]="true" [closable]="true"
  [style]="{ width: '450px' }" [breakpoints]="{ '960px': '95vw' }" [draggable]="false" [resizable]="false">
  <ng-template pTemplate="header"> Editar Registro </ng-template>

  <form [formGroup]="registerForm" (ngSubmit)="saveRegsiter()" class="p-fluid">
    <div class="p-fluid text-center">
      <label for="nombre_equipo">Nombre del equipo</label>
      <input id="nombre_equipo" type="text" pInputText formControlName="nombre_equipo" />

      <label for="participantes">Participantes</label>
      <input id="participantes" type="text" pInputText formControlName="participantes" />

      <label for="correo">Correo</label>
      <input id="correo" type="text" pInputText formControlName="correo" />

      <p-divider></p-divider>

      <div class="field mt-3">
        <label>Pago actual</label>
        <div class="mt-1">
          <p-tag [severity]="statusPagoStyle(selectedCall?.pagado)" [value]="statusPago(selectedCall?.pagado)"></p-tag>
        </div>
      </div>

      <p-divider></p-divider>

      <div class="field mt-3">
        <label>Fechas</label>
        <div class="grid mt-2">
          <div class="col-12 md:col-6">
            <span class="font-bold">Inscripción:</span>
            <span>
              {{ selectedCall?.created_at | date : "dd/MM/yyyy" }}
            </span>
          </div>
          <div class="col-12 md:col-6">
            <span class="font-bold">Pago:</span>
            <span>
              {{ fechaPago | date : "dd/MM/yyyy" }}
            </span>
          </div>
        </div>
      </div>
    </div>
    <div class="dialog-footer">
      <p-button icon="pi pi-times" (click)="visibleRegister = false" label="Cancelar"
        styleClass="p-button-outlined p-button-danger"></p-button>
      <p-button icon="pi pi-check" [disabled]="registerForm.invalid" type="submit"
        [label]="isEditMode ? 'Actualizar' : 'Agregar'" styleClass="p-button-success"
        [disabled]="!botonActualizar"></p-button>
    </div>
  </form>
</p-dialog>

<p-confirmPopup></p-confirmPopup>

<p-dialog header="Registros de Convocatoria" [(visible)]="visibleRegisters" [modal]="true">
  <p-table [value]="currentRegisters">
    <ng-template pTemplate="header">
      <tr>
        <th>Participante</th>
        <th>Correo</th>
        <th>Código</th>
        <th>Estado del pago</th>
        <th>Acciones</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-registro>
      <tr>
        <td>{{ registro.participantes }}</td>
        <td>{{ registro.correo }}</td>
        <td>{{ registro.codigo }}</td>
        <td>
          <p-tag [severity]="getStatusSeverity(registro.pagado)" [value]="statusPago(registro.pagado)"
            (click)="onChangeStatus(registro, $event)" styleClass="cursor-pointer" pTooltip="Clic para cambiar estado"
            tooltipPosition="top">
          </p-tag>
        </td>
        <td>
          <button (click)="editRegister(registro)" pButton icon="pi pi-pencil"
            class="p-button-rounded p-button-success"></button>
          <button (click)="deleteRegister(registro.id)" pButton icon="pi pi-trash"
            class="p-button-rounded p-button-danger"></button>
        </td>
      </tr>
    </ng-template>
  </p-table>
</p-dialog>